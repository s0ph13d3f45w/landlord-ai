<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel - SuperAdmin AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dashboard-modern.css">
</head>
<body>
  <div class="dashboard-container">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <h1><span class="logo-icon">ğŸ </span> SuperAdmin AI</h1>
      </div>
      
      <nav>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="/dashboard" class="nav-link active">
              <span class="nav-icon">ğŸ“Š</span>
              Panel
            </a>
          </li>
          <li class="nav-item">
            <a href="/dashboard/properties" class="nav-link">
              <span class="nav-icon">ğŸ¢</span>
              Propiedades
            </a>
          </li>
          <li class="nav-item">
            <a href="/dashboard/tenants" class="nav-link">
              <span class="nav-icon">ğŸ‘¥</span>
              Inquilinos
            </a>
          </li>
          <li class="nav-item">
            <a href="/logout" class="nav-link">
              <span class="nav-icon">ğŸšª</span>
              Cerrar SesiÃ³n
            </a>
          </li>
        </ul>
      </nav>
      
      <div class="sidebar-footer" style="padding: 1rem 2rem; margin-top: auto; border-top: 1px solid var(--border); color: var(--text-medium);">
        <p><%= landlordName %></p>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Header -->
      <header class="dashboard-header">
        <h2>Panel General</h2>
        <p class="header-subtitle">Bienvenido a tu centro de administraciÃ³n</p>
      </header>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Propiedades</div>
          <div class="stat-value"><%= properties.length %></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Inquilinos</div>
          <div class="stat-value"><%= tenants.length %></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Mensajes</div>
          <div class="stat-value"><%= messages.length %></div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="button-group">
        <button class="btn btn-primary" onclick="showAddTenantModal()">
          <span>â•</span> Agregar Inquilino
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/dashboard/properties'">
          <span>ğŸ¢</span> Agregar Propiedad
        </button>
      </div>

      <!-- Tenants Section -->
      <% if (tenants.length > 0) { %>
      <section>
        <h3 class="section-title">Inquilinos Activos</h3>
        
        <div class="tenants-grid">
          <% tenants.forEach(tenant => { %>
          <div class="tenant-card">
            <div class="tenant-header">
              <div>
                <h4 class="tenant-name"><%= tenant.name %></h4>
                <p class="tenant-property">
                  <span class="tenant-icon">ğŸ“</span>
                  <%= tenant.properties?.address || 'Sin propiedad' %>
                </p>
              </div>
              <button class="delete-btn" onclick="deleteTenant('<%= tenant.id %>', '<%= tenant.name %>')" title="Eliminar">ğŸ—‘ï¸</button>
            </div>
            
            <div class="tenant-info">
              <div class="info-row">
                <span class="info-icon">ğŸ“±</span>
                <span><%= tenant.phone %></span>
              </div>
              <% if (tenant.move_in_date) { %>
              <div class="info-row">
                <span class="info-icon">ğŸ“…</span>
                <span>Desde: <%= new Date(tenant.move_in_date).toLocaleDateString('es-MX') %></span>
              </div>
              <% } %>
            </div>
          </div>
          <% }); %>
        </div>
      </section>
      <% } %>

      <!-- Messages Section -->
      <section>
        <h3 class="section-title">Mensajes Recientes</h3>
        
        <div class="messages-container">
          <% if (messages.length === 0) { %>
            <div class="empty-state">
              <div class="empty-icon">ğŸ’¬</div>
              <h3>No hay mensajes todavÃ­a</h3>
              <p>Tus inquilinos pueden enviar mensajes por WhatsApp</p>
            </div>
          <% } else { %>
            <% messages.forEach(msg => { %>
            <div class="message-card <%= msg.category ? msg.category.toLowerCase() : '' %>">
              <div class="message-header">
                <div class="message-tenant">
                  <h4 class="tenant-name-msg"><%= msg.tenants?.name || 'Inquilino' %></h4>
                  <p class="tenant-property-msg">
                    <span>ğŸ“</span>
                    <%= msg.tenants?.properties?.address || 'Propiedad' %>
                  </p>
                </div>
                <div class="message-meta">
                  <% if (msg.category) { %>
                  <span class="message-category category-<%= msg.category.toLowerCase() %>"><%= msg.category %></span>
                  <% } %>
                  <span class="message-time"><%= new Date(msg.created_at).toLocaleString('es-MX', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
                </div>
              </div>
              
              <div class="message-content">
                <div>
                  <p class="message-label">Inquilino:</p>
                  <div class="message-text"><%= msg.message_body %></div>
                </div>
                
                <% if (msg.ai_response) { %>
                <div>
                  <p class="message-label">Respuesta IA:</p>
                  <div class="ai-response"><%= msg.ai_response %></div>
                </div>
                <% } %>
              </div>
              
              <% if (msg.needs_landlord_attention) { %>
                <button class="respond-btn" onclick="replyToTenant('<%= msg.tenants?.phone || '' %>', '<%= msg.tenants?.name || &quot;Inquilino&quot; %>')">
                Responder
              </button>
              <% } %>
            </div>
            <% }); %>
          <% } %>
        </div>
      </section>

    </main>
  </div>
  
  <!-- Add Tenant Modal -->
  <div id="addTenantModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Agregar Nuevo Inquilino</h2>
      <% if (properties.length === 0) { %>
        <p style="color: #ef4444; margin-bottom: 1rem;">
          âš ï¸ Primero debes <a href="/dashboard/properties" style="color: var(--green);">agregar una propiedad</a>
        </p>
      <% } else { %>
        <form action="/dashboard/tenants/add" method="POST">
          <input type="text" name="name" placeholder="Nombre del Inquilino" required>
          <input type="tel" name="phone" placeholder="WhatsApp (+52...)" required>
          <select name="property_id" required>
            <option value="">Seleccionar Propiedad</option>
            <% properties.forEach(prop => { %>
              <option value="<%= prop.id %>"><%= prop.address %></option>
            <% }); %>
          </select>
          <input type="date" name="move_in_date" placeholder="Fecha de Entrada">
          <button type="submit" class="btn btn-primary">Agregar Inquilino</button>
        </form>
      <% } %>
    </div>
  </div>
  
  <!-- Reply Modal -->
  <div id="replyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeReplyModal()">&times;</span>
      <h2>Responder a <span id="replyTenantName"></span></h2>
      <textarea id="replyMessage" placeholder="Escribe tu mensaje..." rows="4"></textarea>
      <button onclick="sendReply()" class="btn btn-primary">Enviar por WhatsApp</button>
    </div>
  </div>
  
  <script>
    let currentTenantPhone = '';
    
    function showAddTenantModal() {
      document.getElementById('addTenantModal').style.display = 'block';
    }
    
    function closeModal() {
      document.getElementById('addTenantModal').style.display = 'none';
    }
    
    function replyToTenant(phone, name) {
      currentTenantPhone = phone;
      document.getElementById('replyTenantName').textContent = name;
      document.getElementById('replyModal').style.display = 'block';
    }
    
    function closeReplyModal() {
      document.getElementById('replyModal').style.display = 'none';
      document.getElementById('replyMessage').value = '';
    }
    
    async function sendReply() {
      const message = document.getElementById('replyMessage').value;
      if (!message) return alert('Por favor escribe un mensaje');
      
      const response = await fetch('/dashboard/reply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tenant_phone: currentTenantPhone, message })
      });
      
      const result = await response.json();
      if (result.success) {
        alert('Â¡Mensaje enviado!');
        closeReplyModal();
        location.reload();
      } else {
        alert('Error al enviar mensaje: ' + result.error);
      }
    }
    
    function deleteTenant(tenantId, tenantName) {
      if (confirm(`Â¿EstÃ¡s seguro que quieres eliminar a ${tenantName}?\n\nEsto tambiÃ©n eliminarÃ¡ todos sus mensajes.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/tenants/delete/${tenantId}`;
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.className === 'modal') {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>
</html>
